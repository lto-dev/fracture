{
  "$schema": "https://apiquest.net/schemas/collection-v1.0.json",
  "info": {
    "id": "oauth-demo",
    "name": "OAuth Workflow Demo",
    "version": "1.0.0",
    "description": "Demonstrates dynamic header manipulation and OAuth-style token handling"
  },
  "variables": [
    {
      "key": "apiUrl",
      "value": "https://jsonplaceholder.typicode.com"
    },
    {
      "key": "userId",
      "value": "1"
    }
  ],
  "protocol": "http",
  "items": [
    {
      "type": "request",
      "id": "req-1",
      "name": "Simulate OAuth Token Request",
      "protocol": "http",
      "data": {
        "method": "POST",
        "url": "{{apiUrl}}/posts",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": "{\"title\": \"Auth Request\", \"body\": \"Simulating OAuth\", \"userId\": 1}"
      },
      "preRequestScript": "// Simulate preparing OAuth request\nconsole.log('=== OAuth Token Request ===');\nconsole.log('Requesting token from auth server...');\n\n// Add custom headers dynamically\nquest.scope.variables.set('X-ClientId', 'my-app-12345');\nquest.scope.variables.set('X-Request-Time', new Date().toISOString());",
      "postRequestScript": "console.log('Response:', quest.response.body);\n\nquest.test('Token request successful', () => {\n  expect(quest.response.status).to.equal(201);\n});\n\nquest.test('Extract and save token', () => {\n  const response = quest.response.json();\n  \n  // In real OAuth, you'd get a token from response\n  // Here we simulate it using the response id\n  const fakeToken = 'Bearer_token_' + response.id;\n  \n  console.log('Generated token:', fakeToken);\n  \n  // Store token globally for use in subsequent requests\n  quest.global.variables.set('authToken', fakeToken);\n  \n  expect(fakeToken).to.be.a('string');\n  expect(fakeToken.length).to.be.greaterThan(0);\n});"
    },
    {
      "type": "request",
      "id": "req-2",
      "name": "Protected API Call (Uses Token)",
      "protocol": "http",
      "data": {
        "method": "GET",
        "url": "{{apiUrl}}/posts/{{userId}}",
        "headers": {
          "Accept": "application/json"
        }
      },
      "preRequestScript": "// Get the token from global variables\nconst token = quest.global.variables.get('authToken');\n\nconsole.log('=== Protected API Request ===');\nif (token) {\n  console.log('Using token:', token);\n} else {\n  console.log('WARNING: No token found!');\n}\n\n// In a real scenario, you'd modify the request to add the Authorization header\n// Since we can't modify request.data directly in current implementation,\n// we demonstrate by storing it in a variable that the test can verify\nquest.scope.variables.set('tokenUsed', token || 'NO_TOKEN');",
      "postRequestScript": "quest.test('Request completed', () => {\n  expect(quest.response.status).to.equal(200);\n});\n\nquest.test('Token was available from previous request', () => {\n  const tokenUsed = quest.scope.variables.get('tokenUsed');\n  console.log('Token from previous request:', tokenUsed);\n  \n  expect(tokenUsed).to.not.equal('NO_TOKEN');\n  expect(tokenUsed).to.contain('Bearer_token_');\n});\n\nquest.test('Response contains post data', () => {\n  const body = quest.response.json();\n  expect(body).to.have.property('id');\n  expect(body).to.have.property('title');\n});"
    },
    {
      "type": "request",
      "id": "req-3",
      "name": "Dynamic Headers Example",
      "protocol": "http",
      "data": {
        "method": "GET",
        "url": "{{apiUrl}}/posts",
        "headers": {
          "Accept": "application/json",
          "User-Agent": "ApiQuest/1.0"
        }
      },
      "preRequestScript": "// Demonstrate setting various dynamic headers\nconsole.log('=== Dynamic Headers Demo ===');\n\n// Timestamp for request tracking\nconst timestamp = Date.now();\nquest.scope.variables.set('X-Request-Timestamp', timestamp.toString());\nconsole.log('Request timestamp:', timestamp);\n\n// Correlation ID for distributed tracing\nconst correlationId = 'req-' + Math.random().toString(36).substring(7);\nquest.scope.variables.set('X-Correlation-ID', correlationId);\nconsole.log('Correlation ID:', correlationId);\n\n// Environment indicator\nquest.scope.variables.set('X-Environment', 'testing');\n\n// If we have auth token, prepare to use it\nconst token = quest.global.variables.get('authToken');\nif (token) {\n  quest.scope.variables.set('Authorization', token);\n  console.log('Authorization header prepared');\n}",
      "postRequestScript": "quest.test('Headers were set in pre-request', () => {\n  const timestamp = quest.scope.variables.get('X-Request-Timestamp');\n  const correlationId = quest.scope.variables.get('X-Correlation-ID');\n  const environment = quest.scope.variables.get('X-Environment');\n  \n  console.log('Verified headers:');\n  console.log('  Timestamp:', timestamp);\n  console.log('  Correlation ID:', correlationId);\n  console.log('  Environment:', environment);\n  \n  expect(timestamp).to.not.be.null;\n  expect(correlationId).to.not.be.null;\n  expect(environment).to.equal('testing');\n});\n\nquest.test('API response valid', () => {\n  expect(quest.response.status).to.equal(200);\n  const body = quest.response.json();\n  expect(body).to.be.an('array');\n});"
    }
  ]
}
